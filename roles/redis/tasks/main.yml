---
- name: clearall value
  debug:
    msg: "{{ clearall }}"
    
- name: Check that the data exists
  stat:
    path: "{{ data_dir }}"
  register: file_status

- name: clear data
  shell: docker-compose down
  args:
   chdir: "{{ data_dir }}" 
  when: clearall == "yes" and file_status.stat.exists == True

- name: Ansible delete directory example
  shell: rm -rf {{ data_dir }}
  when: clearall=='yes' and file_status.stat.exists == True

- name: somaxconneconn
  shell: echo 511 > /proc/sys/net/core/somaxconn

- name: copy docker compose
  shell: mkdir -p {{ data_dir }}/data

- name: copy docker compose
  template: src=docker-compose.yml.j2 dest={{ data_dir }}/docker-compose.yml

- name: copy redis
  template: src=redis.conf.j2 dest={{ data_dir }}/redis.conf

- name: hugepage never
  shell: echo never > /sys/kernel/mm/transparent_hugepage/enabled

- name: sysctl redis.conf
  template:
    src: redis-conn.conf.j2
    dest: /etc/sysctl.d/redis-conn.conf

- name: sysctl redis-conn.conf
  shell: sysctl --system

- name: stop redis
  shell: docker-compose down
  args:
   chdir: "{{ data_dir }}"

- name: start redis
  shell: docker-compose  up -d
  args:
   chdir: "{{ data_dir }}"
   
- name: validate redis
  shell: sleep 10 && docker-compose ps
  args:
   chdir: "{{ data_dir }}"
  register: check

- name: show
  debug: var=check.stdout verbosity=0
