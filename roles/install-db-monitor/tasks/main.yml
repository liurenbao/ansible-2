- name: set java env conf ~/.bashrc
  lineinfile:
    dest: '/home/{{ gaussdb_user }}/.bashrc'
    state: present
    line: "{{ item }}"
  with_items:
    - "export JAVA_HOME={{ jdk_dir }}"
    - "export JRE_HOME=${JAVA_HOME}/jre"
    - "export CLASSPATH=.:${JAVA_HOME}/lib:${JRE_HOME}/lib"
    - "export PATH=${JAVA_HOME}/bin:$PATH"

- name: source bashrc
  shell: 'source /home/{{ gaussdb_user }}/.bashrc'

- name: create agent root dir
  file:
    path: '{{ gaussdb_monitor_agent_root_dir }}/{{ gaussdb_user }}'
    state: directory

- name: create wsr dir
  file:
    path: /wsr
    state: directory
    owner: '{{ gaussdb_user }}'
    group: '{{ gaussdb_user_group }}'

- name: send agent application.yml
  template:
    src: agent/application.yml.j2
    dest: '{{ gaussdb_monitor_agent_root_dir }}/{{ gaussdb_user }}/application.yml'

- name: send agent jar
  copy:
    src: agent/hisi-uoamp-monitor-agent-1.0-SNAPSHOT.jar
    dest: '{{ gaussdb_monitor_agent_root_dir }}/{{ gaussdb_user }}/agent.jar'
    owner: '{{ gaussdb_user }}'
    group: '{{ gaussdb_user_group }}'

- name: chmod agent dir
  file:
    path: '{{ gaussdb_monitor_agent_root_dir }}/{{ gaussdb_user }}'
    state: directory
    owner: '{{ gaussdb_user }}'
    group: '{{ gaussdb_user_group }}'
    recurse: yes

- name: stop agent
  shell: |
    pid=$(ps -ef | grep -v grep | grep {{ gaussdb_user }} | grep agent.jar | awk '{print $2}')
    kill -9 $pid
  ignore_errors: yes
#启动不起来执行以下命令
#ansible -i gaussdb-hosts gaussdb -m shell -a "cd /data01/gaussdb-monitor-agent/omm/ && nohup java -jar agent.jar > /dev/null 2>&1 &"
- name: start agent
  become: yes
  become_user: '{{ gaussdb_user }}'
  shell: |
    rm -rf logs
    nohup java -jar agent.jar > /dev/null 2>&1 &
  args:
    chdir: '{{ gaussdb_monitor_agent_root_dir }}/{{ gaussdb_user }}'

#- name: create filebeat dir
#  command: rm -rf /data01/filebeat/

- name: create filebeat dir
  file:
    path: '/data01/filebeat/'
    state: directory

- name: install rsync
  shell: yum install rsync -y

- name: send filebeat package
  synchronize:
    src: '{{ package_dir }}/filebeat/'
    dest: '/data01/filebeat/'

- name: send filebeat.yml
  template:
    src: filebeat.yml.j2
    dest: /data01/filebeat/filebeat-7.3.0-linux-x86_64/filebeat.yml

- name: add execute permission
  file:
    dest: '{{ item }}'
    mode: 0770
  with_items:
    - "/data01/filebeat/filebeat-7.3.0-linux-x86_64/filebeat"
    - "/data01/filebeat/filebeat_monitor.sh"
    - "/data01/filebeat/filebeat-7.3.0-linux-x86_64/start.sh"

- name: chown dir
  file:
    path: '/data01/filebeat/'
    state: directory
    owner: '{{ gaussdb_user }}'
    group: '{{ gaussdb_user_group }}'
    recurse: yes

- name: add cron job for filebeat
  cron:
    name: start filebeat
    minute: "*/2"
    job: "/data01/filebeat/filebeat_monitor.sh"
    user: '{{ gaussdb_user }}'

- name: start filebeat
  become: yes
  become_user: '{{ gaussdb_user }}'
  command: "./filebeat_monitor.sh"
  args:
    chdir: /data01/filebeat

- name: check if process started success
  become: yes
  become_user: '{{ gaussdb_user }}'
  shell: ps -ef | grep -v grep | grep -E "filebeat|agent.jar"
  register: process

- name: show process
  debug:
    msg: '{{ process.stdout_lines }}'
