- name: create es dir
  file:
    path: "{{ es_root_dir }}"
    state: directory

- name: dispatch docker-compose
  template:
    src: docker-compose.yml.j2
    dest: "{{ es_root_dir }}/docker-compose.yml"

- name: dispatch config file
  template:
    src: elasticsearch.yml.j2
    dest: "{{ es_root_dir }}/elasticsearch.yml"

- name: chmod es data dir
  file:
    path: '{{ es_root_dir }}/data'
    mode: 0776
    state: directory
    recurse: yes

- name: docker-compose down
  shell: docker-compose -f {{ es_root_dir }}/docker-compose.yml down

- name: docker-compose up
  shell: docker-compose -f {{ es_root_dir }}/docker-compose.yml up -d

- name: add clear cron job
  cron:
    name: 'clear es expired index'
    minute: 0
    hour: 0
    day: '{{ es_clear_at_day }}'
    job: 'curl -XDELETE http://localhost:9200/*-$(date -d "{{ es_clear_month_ago }} month ago" +%Y-%m)-*'

- name: wait es start complete
  wait_for:
    port: 9200
    delay: 5

- name: check es state
  uri:
    url: http://localhost:9200/_cat/health?v
    status_code: 200
    return_content: yes
  register: this
  failed_when: "'You Know, for Search' not in this.content"

- name: send index template conf
  template:
    src: index-template.json.j2
    dest: '{{ es_root_dir }}/index-template.json'

- name: add index template
  shell: |
    curl -H 'Content-Type: application/json' -XPUT -d @index-template.json http://localhost:9200/_template/app-log
  args:
    chdir: '{{ es_root_dir }}'