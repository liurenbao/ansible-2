- name: ensure directory structure exists
  file:
    path: '{{ monitor_manifest_root_dir }}'
    state: directory

- name: ensure directories exists
  file:
    state: directory
    dest: '{{ monitor_manifest_root_dir }}/{{ item.path }}'
  with_filetree: 'files/'
  when: item.state == 'directory'

- name: copy config templates to master
  copy:
    src: '{{ item.src }}'
    dest: "{{ monitor_manifest_root_dir }}/{{ item.path | regex_replace('\\.j2$', '') }}"
  with_filetree: 'files/'
  when: item.state == 'file'

- name: copy deploy.sh
  template:
    src: deploy.sh.j2
    dest: "{{ monitor_manifest_root_dir }}/deploy.sh"

- name: deploy
  shell: "chmod +x {{ monitor_manifest_root_dir }}/deploy.sh && /bin/bash -c {{ monitor_manifest_root_dir }}/deploy.sh"

